<!DOCTYPE html>
<meta charset="utf-8">
<link href="http://cdn.bootcss.com/normalize/4.1.1/normalize.min.css" rel="stylesheet">
  <link href="../lib/style.css" rel="stylesheet">
<style>
svg {
    font: 10px sans-serif;
}

circle {
    -webkit-transition: fill-opacity 250ms linear;
}

.selecting circle {
    fill-opacity: .2;
}

.selecting circle.selected {
    stroke: #f00;
}

.resize path {
    fill: #666;
    fill-opacity: .8;
    stroke: #000;
    stroke-width: 1.5px;
}

.axis path,
.axis line {
    fill: none;
    stroke: gray;
    stroke-width: 2px;
    shape-rendering: crispEdges;
}
.brush .extent {
    fill-opacity: .125;
    shape-rendering: crispEdges;
}
</style>

<body>
    <div id="chartWrap" style='width:1200px;height:400px;background:#efefef;margin-top: 20px;margin-left: 20px;'>
        
    </div>
    <script src="../vendor/jquery.min.js"></script>
    <script src="../vendor/d3.min.js"></script>
    <script src="../vendor/underscore-min.js"></script>
    <script src="../lib/mlpChart.js"></script>
    <script >
        function getRandom(){
            var currentTime = _.now();
            var randomNum = Number((Math.random()*10000).toFixed(4));
            return {
                x: currentTime,
                y: randomNum,
                tip: {
                    "开始时间": mlpChart.utils.dateFormat(currentTime - 1000,"yyyy-MM-dd hh:mm:ss"),
                    "截止时间": mlpChart.utils.dateFormat(currentTime + 1000,"yyyy-MM-dd hh:mm:ss"),
                    "投入工时变化量总和": randomNum
                }
            };          
        }
        $(function(){
            var now = _.now();
            var realTimeChart = mlpChart({
                wrapContainer: '#chartWrap'
            }).realTimeLineChart({
                maxNode: 15,
                updateAnimationTime: 2000,
                brushModule: true,
                dataset: [{
                    data: [{
                        y: 50,
                        x: now,
                        tip: {
                            "开始时间": mlpChart.utils.dateFormat(now - 1000,"yyyy-MM-dd hh:mm:ss"),
                            "截止时间": mlpChart.utils.dateFormat(now + 1000,"yyyy-MM-dd hh:mm:ss"),
                            "投入工时变化量总和": 50
                        }
                    }],
                    name: '602Logo检测机',
                    x: {
                        name: '时间'
                    },
                    y: {
                        name: "sum(投入工时变化量)",
                        as: '投入工时变化量总和'
                    }
                }, {
                    data: [{
                        y: 40,
                        x: now,
                        tip: {
                            "开始时间": now - 1000,
                            "截止时间": now + 1000,
                            "投入工时变化量总和": 40
                        }
                    }],
                    name: '601Logo检测机',
                    x: {
                        name: '料件',
                        as: "材料"
                    },
                    y: {
                        name: "sum(投入工时变化量)",
                        as: '投入工时变化量总和'
                    }
                }]
            }).api.draw();
            setInterval(function(){
                realTimeChart.api.update([getRandom(),getRandom()])
            },2000)
        })
    </script>
    <script>
    var data = d3.range(800).map(Math.random);

    var margin = {
            top: 194,
            right: 50,
            bottom: 214,
            left: 50
        },
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    var x = d3.scale.linear()
        .range([0, width]);

    var y = d3.random.normal(height / 2, height / 8);

    var brush = d3.svg.brush()
        .x(x)
        // .extent([.3, .5])
        .on("brushstart", brushstart)
        .on("brush", brushmove)
        .on("brushend", brushend);

    var arc = d3.svg.arc()
        .outerRadius(height / 2)
        .startAngle(0)
        .endAngle(function(d, i) {
            return i ? -Math.PI : Math.PI;
        });

    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.svg.axis().scale(x).orient("bottom"));

    var circle = svg.append("g").selectAll("circle")
        .data(data)
        .enter().append("circle")
        .attr("transform", function(d) {
            return "translate(" + x(d) + "," + y() + ")";
        })
        .attr("r", 3.5);

    var brushg = svg.append("g")
        .attr("class", "brush")
        .call(brush);

    brushg.selectAll(".resize").append("path")
        .attr("transform", "translate(0," + height / 2 + ")")
        .attr("d", arc);

    brushg.selectAll("rect")
        .attr("height", height);

    brushstart();
    brushmove();

    function brushstart() {
        svg.classed("selecting", true);
    }

    function brushmove() {
        var s = brush.extent();
        circle.classed("selected", function(d) {
            return s[0] <= d && d <= s[1];
        });
    }

    function brushend() {
        console.log('end');
        svg.classed("selecting", !d3.event.target.empty());
    }
    </script>
